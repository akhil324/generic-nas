<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="5">
    <title>RPi Monitor - {{ data.hostname }}</title>
    <style>
        :root {
            --bg-color: #1a1a1a; --text-color: #d0d0d0; --header-color: #569cd6;
            --label-color: #9cdcfe; --value-color: #d4d4d4; --border-color: #444;
            --bar-bg: #333;
            /* 4-Level Colors (Adjusted for better contrast/meaning) */
            --ok-color: #4CAF50; /* Green */
            --low-warn-color: #8BC34A; /* Lime Green */
            --high-warn-color: #FFC107; /* Amber */
            --crit-color: #F44336; /* Red */

            --bar-cpu: var(--ok-color); --bar-mem: var(--ok-color);
            --bar-disk: #03A9F4; /* Light Blue for Disk */

            --info-color: #b5cea8; --dim-color: #888; --font-mono: "DejaVu Sans Mono", "Consolas", "Menlo", monospace;
        }
        body { font-family: var(--font-mono); font-size: 13px; line-height: 1.1; padding: 0.3em; background-color: var(--bg-color); color: var(--text-color); margin: 0; overflow-x: hidden; }
        .container { max-width: 1100px; margin: auto; }
        a { color: var(--label-color); text-decoration: none; } a:hover { text-decoration: underline; }

        /* Banner Section */
        .banner { display: flex; justify-content: space-between; align-items: center; padding: 0.3em 0.5em; margin-bottom: 0.5em; background-color: var(--border-color); color: var(--header-color); white-space: nowrap; }
        .banner-title { font-size: 1.3em; font-weight: bold; text-align: center; flex-grow: 1; }
        .banner-actions button { padding: 0.2em 0.6em; background-color: #a03030; color: #eee; border: 1px solid var(--crit-color); border-radius: 3px; cursor: pointer; font-family: inherit; font-size: 0.9em; }
        .banner-actions button:hover { background-color: var(--crit-color); border-color: #ff6666; }
        .banner-actions button:disabled { background-color: #555; border-color: #777; color: #aaa; cursor: not-allowed; }

        /* Header Bar */
        .header { display: flex; flex-wrap: wrap; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; margin-bottom: 0.5em; white-space: nowrap; }
        .header-item { margin-right: 1.5em; } .header-label { color: var(--label-color); } .header-value { color: var(--value-color); font-weight: bold; }

        /* Main Layout */
        .main-layout { display: flex; flex-wrap: wrap; gap: 1em; }
        .column { flex: 1; min-width: 350px; }

        /* Sections */
        .section { border: 1px solid var(--border-color); margin-bottom: 1em; background-color: #252526; }
        .section-title { background-color: var(--border-color); color: var(--header-color); padding: 0.2em 0.5em; font-weight: bold; text-align: center; }
        .section-content { padding: 0.5em; }

        /* Definition List */
        dl { margin: 0; }
        dt { float: left; width: 12ch; color: var(--label-color); text-align: right; margin-right: 1ch; clear: left; margin-bottom: 0.1em; white-space: nowrap; }
        dd { margin-left: 13ch; margin-bottom: 0.1em; white-space: nowrap; display: block; }
        dd.bar-line { margin-bottom: 0.3em; }

        /* CPU Core Layout */
        .cpu-total-bar { margin-bottom: 0.3em; }
        .cpu-cores { column-count: 2; column-gap: 1ch; margin-top: 0.3em; }
        .cpu-core-item { margin-bottom: 0.1em; white-space: nowrap; display: block; }

        /* Bars with Text Overlay */
        .bar-container { display: inline-block; width: 100%; height: 1em; background-color: var(--bar-bg); border: 1px solid #555; vertical-align: middle; position: relative; overflow: hidden; }
        .bar-fill { display: block; height: 100%; position: absolute; left: 0; top: 0; transition: width 0.3s ease-out; }
        .bar-text { position: absolute; left: 0; top: 0; width: 100%; height: 100%; font-size: 0.9em; line-height: 1em; color: #fff; text-shadow: 1px 1px 1px rgba(0,0,0,0.7); white-space: nowrap; overflow: hidden; text-overflow: clip; display: flex; justify-content: space-between; align-items: center; padding: 0 5px; }
        .bar-label { text-align: left; margin-right: 1ch; }
        .bar-value { text-align: right; font-weight: bold; }

        /* Bar Colors - Applied to .bar-fill */
        .bar-fill.ok { background-color: var(--ok-color); }
        .bar-fill.low-warn { background-color: var(--low-warn-color); }
        .bar-fill.high-warn { background-color: var(--high-warn-color); }
        .bar-fill.crit { background-color: var(--crit-color); }
        .bar-fill.disk { background-color: var(--bar-disk); }

        /* IO Tables */
        .io-table { width: 100%; border-collapse: collapse; margin-top: 0.3em; }
        .io-table th, .io-table td { text-align: left; padding: 0.1em 0.5em; white-space: nowrap; }
        .io-table th { color: var(--label-color); border-bottom: 1px solid var(--border-color); font-weight: normal; }
        .io-table td { color: var(--value-color); }
        .io-table th.num, .io-table td.num { text-align: right; }

        /* Process Table */
        .proc-table { width: 100%; border-collapse: collapse; margin-top: 0.3em; table-layout: fixed; }
        .proc-table th, .proc-table td { text-align: left; padding: 0.1em 0.5em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .proc-table th { color: var(--label-color); border-bottom: 1px solid var(--border-color); font-weight: normal; }
        .proc-table td { color: var(--value-color); }
        .proc-table th.pid, .proc-table td.pid { width: 6ch; } .proc-table th.user, .proc-table td.user { width: 10ch; }
        .proc-table th.cpu, .proc-table td.cpu { width: 6ch; text-align: right; } .proc-table th.mem, .proc-table td.mem { width: 6ch; text-align: right; }
        .proc-table th.name { width: auto; }

        /* Utils */
        .error { color: var(--crit-color); } .info { color: var(--info-color); } .dim { color: var(--dim-color); }

        /* Jinja2 macro for bar with text overlay */
        {% macro overlay_bar(percent, width_ch='100%', type='cpu', label='', value_text='') -%}
            {% set p = percent | float %}
            {% if type == 'cpu' or type == 'mem' %} {# 4-level colors for CPU/Mem #}
                {% set color_class = 'crit' if p > 90 else ('high-warn' if p > 75 else ('low-warn' if p > 50 else 'ok')) %}
            {% else %} {# Simpler for Disk #}
                 {% set color_class = 'crit' if p > 95 else ('high-warn' if p > 85 else type) %}
            {% endif %}
            <span class="bar-container" style="width: {{ width_ch }};"> {# Use ; for style termination #}
                <span class="bar-fill {{ color_class }}" style="width: {{ p }}%;"></span>
                <span class="bar-text">
                    <span class="bar-label">{{ label }}</span>
                    <span class="bar-value">{{ value_text }}</span>
                </span>
            </span>
        {%- endmacro %}

    </style>
</head>
<body>
<div class="container">

    <!-- Banner -->
    <div class="banner">
        <span class="banner-title">RPi Monitor :: {{ data.hostname }}</span>
        <div class="banner-actions">
            <form id="reboot-form" action="{{ url_for('reboot') }}" method="post" onsubmit="return confirm('Are you sure you want to reboot the system?');" style="display: inline;">
                <button type="submit" {% if not data.is_linux %}disabled title="Reboot only available on Linux"{% endif %}>Reboot</button>
            </form>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <span class="header-item"><span class="header-label">OS:</span> <span class="header-value">{{ data.os_name }}</span></span>
        <span class="header-item"><span class="header-label">IP:</span> <span class="header-value">{{ data.ip_address }}</span></span> {# Changed Load to IP #}
        <span class="header-item"><span class="header-label">Temp:</span> <span class="header-value">{{ data.temperature }}</span></span>
        <span class="header-item"><span class="header-label">Uptime:</span> <span class="header-value">{{ data.uptime }}</span></span>
    </div>

    <div class="main-layout">
        <div class="column">
            <!-- CPU Section -->
            <div class="section">
                <div class="section-title">CPU</div>
                <div class="section-content">
                    <div class="cpu-total-bar">
                        {# Use 100% width for total bar #}
                        {{ overlay_bar(data.cpu_total, width_ch='100%', type='cpu', label='Total:', value_text='%.1f%%'|format(data.cpu_total)) }}
                    </div>
                    <div class="cpu-cores">
                        {% for core_percent in data.cpu_cores %}
                        <div class="cpu-core-item">
                            {# Use 98% width for core bars to fit columns better #}
                            {# Removed label from inside core bar #}
                            {{ overlay_bar(core_percent, width_ch='98%', type='cpu', label='Core %d:'|format(loop.index0), value_text='%.1f%%'|format(core_percent)) }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Memory Section -->
            <div class="section">
                <div class="section-title">Memory</div>
                <div class="section-content">
                    {% set mem = data.memory.virtual %}
                    {% if mem.error %} <p class="metric error"><span class="label">Error:</span> {{ mem.error }}</p>
                    {% else %}
                    <dl>
                        <dt>Total:</dt><dd><span class="value">{{ mem.total }}</span> {{ overlay_bar(mem.percent, width_ch=25, type='mem', label='Mem:', value_text='%.1f%%'|format(mem.percent)) }}</dd>
                        <dt>Used:</dt><dd><span class="value">{{ mem.used }}</span></dd>
                        <dt>Free:</dt><dd><span class="value">{{ mem.free }}</span></dd>
                        {% if data.is_linux %}
                        <dt>Active:</dt><dd><span class="value">{{ mem.active }}</span></dd>
                        <dt>Inactive:</dt><dd><span class="value">{{ mem.inactive }}</span></dd>
                        <dt>Cached:</dt><dd><span class="value">{{ mem.cached }}</span></dd>
                        <dt>Buffers:</dt><dd><span class="value">{{ mem.buffers }}</span></dd>
                        {% endif %}
                    </dl>
                    {% endif %}
                </div>
            </div>

            <!-- Network I/O Section -->
            <div class="section">
                <div class="section-title">Network I/O (Top 4)</div>
                <div class="section-content">
                    {% if data.net_io %}
                    <table class="io-table">
                        <thead><tr><th>Interface</th><th class="num">Rx Rate</th><th class="num">Tx Rate</th><th class="num">Rx Total</th><th class="num">Tx Total</th></tr></thead>
                        <tbody>
                        {% for nic in data.net_io %}
                        <tr><td>{{ nic.name }}</td><td class="num">{{ nic.rx_rate }}</td><td class="num">{{ nic.tx_rate }}</td><td class="num">{{ nic.rx_total }}</td><td class="num">{{ nic.tx_total }}</td></tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% else %} <p class="metric dim"><span class="label">Status:</span> No network interfaces found.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Service Network I/O Section -->
            <div class="section">
                <div class="section-title">Service Network I/O</div>
                <div class="section-content">
                    {% if data.service_net_io.error %}
                    <p class="metric error"><span class="label">Error:</span> {{ data.service_net_io.error }}</p>
                    {% elif data.service_net_io.info %}
                    <p class="metric dim"><span class="label">Status:</span> {{ data.service_net_io.info }}</p>
                    {% elif data.service_net_io %}
                    <table class="io-table">
                        <thead><tr><th>Service</th><th class="num">Recv Rate</th><th class="num">Sent Rate</th></tr></thead>
                        <tbody>
                        {% for service, stats in data.service_net_io.items() %}
                        <tr><td>{{ service }}</td><td class="num">{{ stats.recv_rate }}</td><td class="num">{{ stats.sent_rate }}</td></tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="metric dim"><span class="label">Status:</span> No service I/O data available.</p>
                    {% endif %}
                </div>
            </div>


        </div><!-- /column -->

        <div class="column">
            <!-- Shares Section -->
            <div class="section">
                <div class="section-title">Shares <span class="dim">({{ SHARE_BASE_PATH }})</span></div>
                <div class="section-content">
                    {% if data.disk_fs %}
                    {% for disk in data.disk_fs %}
                    <p class="metric">
                        {{ overlay_bar(disk.percent, width_ch='98%', type='disk', label='%s:'|format(disk.mountpoint), value_text='%s/%s'|format(disk.used, disk.total)) }}
                    </p>
                    {% endfor %}
                    {% else %} <p class="metric dim"><span class="label">Status:</span> No shared disks found/mounted.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Disk I/O Section -->
            <div class="section">
                <div class="section-title">Disk I/O</div>
                <div class="section-content">
                    {% if data.disk_io %}
                    <table class="io-table">
                        <thead><tr><th>Disk</th><th class="num">Read Rate</th><th class="num">Write Rate</th><th class="num">Read Total</th><th class="num">Write Total</th></tr></thead>
                        <tbody>
                        {% for disk, stats in data.disk_io.items() %}
                        <tr><td>{{ disk }}</td><td class="num">{{ stats.read_rate }}</td><td class="num">{{ stats.write_rate }}</td><td class="num">{{ stats.read_total }}</td><td class="num">{{ stats.write_total }}</td></tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% else %} <p class="metric dim"><span class="label">Status:</span> No physical disks found for I/O.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Connections Section -->
            <div class="section">
                <div class="section-title">Connections</div>
                <div class="section-content">
                    <dl>
                        <dt>VPN Type:</dt><dd>{{ data.connections.type }}</dd>
                        {% if data.connections.peers %}
                        <dt>VPN Peers:</dt>
                        <dd><ul class="conn-list">{% for peer in data.connections.peers %}<li><span class="info">{{ peer }}</span></li>{% endfor %}</ul></dd>
                        {% elif data.connections.type != 'None' %}
                        <dt>VPN Peers:</dt><dd><span class="dim">None detected or service inactive.</span></dd>
                        {% endif %}
                        {% if data.connections.smb_clients %}
                        <dt>SMB Clients:</dt>
                        <dd><ul class="conn-list">{% for client in data.connections.smb_clients %}<li><span class="info">{{ client }}</span></li>{% endfor %}</ul></dd>
                        {% else %}
                        <dt>SMB Clients:</dt><dd><span class="dim">No active clients detected.</span></dd>
                        {% endif %}
                        {% if data.connections.error %}
                        <dt class="error">Error:</dt><dd class="error">{{ data.connections.error }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Top Processes Section -->
            <div class="section">
                <div class="section-title">Top Processes (by MEM)</div>
                <div class="section-content">
                    {% if data.top_procs %}
                    <table class="proc-table">
                        <thead><tr><th class="pid">PID</th><th class="user">USER</th><th class="cpu">CPU%</th><th class="mem">MEM%</th><th class="name">NAME</th></tr></thead>
                        <tbody>
                        {% for proc in data.top_procs %}
                        <tr>
                            <td class="pid">{{ proc.pid }}</td><td class="user">{{ proc.user }}</td>
                            <td class="cpu">{{ "%.1f"|format(proc.cpu) }}</td><td class="mem">{{ "%.1f"|format(proc.mem) }}</td>
                            <td class="name" title="{{ proc.name }}">{{ proc.name }}</td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% else %} <p class="metric dim"><span class="label">Status:</span> Could not retrieve process list.</p>
                    {% endif %}
                </div>
            </div>

        </div><!-- /column -->
    </div><!-- /main-layout -->

</div><!-- /container -->
</body>
</html>